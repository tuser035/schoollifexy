# 2025ë…„ 12ì›” 13ì¼ ì½”ë“œ ìˆ˜ì • ë‚´ìš©

## ğŸ“š ì˜¤ëŠ˜ ë°°ìš¸ ë‚´ìš©
1. ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜(RPC) ë§Œë“¤ê¸°
2. Reactì—ì„œ RPC í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°
3. í…Œì´ë¸”ì—ì„œ ì»¬ëŸ¼ ì œê±°í•˜ê¸°

---

## 1ï¸âƒ£ êµì‚¬ê°€ ìì‹ ì˜ ê¸°ë¡ì„ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì¶”ê°€

### ì™œ í•„ìš”í• ê¹Œìš”?
êµì‚¬ê°€ ì‹¤ìˆ˜ë¡œ ì˜ëª»ëœ ìƒì /ë²Œì ì„ ì…ë ¥í–ˆì„ ë•Œ, ì§ì ‘ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆì–´ì•¼ í•´ìš”.
í•˜ì§€ë§Œ ë‹¤ë¥¸ êµì‚¬ê°€ ì…ë ¥í•œ ê¸°ë¡ì€ ìˆ˜ì •í•˜ë©´ ì•ˆ ë˜ê² ì£ ? ê·¸ë˜ì„œ **"ìê¸°ê°€ ì…ë ¥í•œ ê²ƒë§Œ"** ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ìš”.

### ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ ë§Œë“¤ê¸° (SQL)

ë°ì´í„°ë² ì´ìŠ¤ì— ìƒˆë¡œìš´ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ìš”. ì´ í•¨ìˆ˜ëŠ” **ë³´ì•ˆ**ì´ ì ìš©ë˜ì–´ ìˆì–´ì„œ ì•ˆì „í•´ìš”.

#### ìƒì  ìˆ˜ì • í•¨ìˆ˜
```sql
CREATE OR REPLACE FUNCTION public.teacher_update_merit(
  teacher_id_input uuid,      -- êµì‚¬ ID
  merit_id_input uuid,        -- ìˆ˜ì •í•  ìƒì  ID
  category_input text,        -- ìƒˆë¡œìš´ ì¹´í…Œê³ ë¦¬
  reason_input text,          -- ìƒˆë¡œìš´ ì‚¬ìœ 
  score_input integer         -- ìƒˆë¡œìš´ ì ìˆ˜
)
RETURNS boolean               -- ì„±ê³µí•˜ë©´ true, ì‹¤íŒ¨í•˜ë©´ false
LANGUAGE plpgsql
SECURITY DEFINER              -- ë³´ì•ˆ ì„¤ì •
SET search_path TO 'public'
AS $$
BEGIN
  -- ë¨¼ì € ì´ êµì‚¬ê°€ ì´ ìƒì ì„ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ìš”
  IF NOT EXISTS (
    SELECT 1 FROM public.merits 
    WHERE id = merit_id_input AND teacher_id = teacher_id_input
  ) THEN
    -- ê¶Œí•œì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤˜ìš”
    RAISE EXCEPTION 'ê¶Œí•œì´ ì—†ê±°ë‚˜ ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
  END IF;

  -- í™•ì¸ì´ ë˜ë©´ ìƒì  ì •ë³´ë¥¼ ìˆ˜ì •í•´ìš”
  UPDATE public.merits
  SET category = category_input, 
      reason = reason_input, 
      score = score_input
  WHERE id = merit_id_input AND teacher_id = teacher_id_input;

  -- ìˆ˜ì •ì´ ì˜ ëëŠ”ì§€ ê²°ê³¼ë¥¼ ì•Œë ¤ì¤˜ìš”
  RETURN FOUND;
END;
$$;
```

#### ğŸ” ì½”ë“œ ì„¤ëª…
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `CREATE OR REPLACE FUNCTION` | ìƒˆë¡œìš´ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ìš” (ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°) |
| `teacher_id_input uuid` | í•¨ìˆ˜ì— ì „ë‹¬í•  ê°’ (ë§¤ê°œë³€ìˆ˜) |
| `RETURNS boolean` | í•¨ìˆ˜ê°€ ëŒë ¤ì£¼ëŠ” ê°’ì˜ íƒ€ì… |
| `SECURITY DEFINER` | ë³´ì•ˆ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•´ìš” |
| `IF NOT EXISTS` | ì¡°ê±´ì„ í™•ì¸í•´ìš” |
| `RAISE EXCEPTION` | ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œìš” |
| `UPDATE ... SET` | ë°ì´í„°ë¥¼ ìˆ˜ì •í•´ìš” |
| `RETURN FOUND` | ìˆ˜ì •ì´ ëëŠ”ì§€ ê²°ê³¼ë¥¼ ì•Œë ¤ì¤˜ìš” |

#### ìƒì  ì‚­ì œ í•¨ìˆ˜
```sql
CREATE OR REPLACE FUNCTION public.teacher_delete_merit(
  teacher_id_input uuid,
  merit_id_input uuid
)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $$
BEGIN
  -- ê¶Œí•œ í™•ì¸
  IF NOT EXISTS (
    SELECT 1 FROM public.merits 
    WHERE id = merit_id_input AND teacher_id = teacher_id_input
  ) THEN
    RAISE EXCEPTION 'ê¶Œí•œì´ ì—†ê±°ë‚˜ ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
  END IF;

  -- ì‚­ì œ ì‹¤í–‰
  DELETE FROM public.merits
  WHERE id = merit_id_input AND teacher_id = teacher_id_input;

  RETURN FOUND;
END;
$$;
```

> ğŸ’¡ **ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë²Œì (demerit)ê³¼ ì´ë‹¬ì˜ í•™ìƒ(monthly) í•¨ìˆ˜ë„ ë§Œë“¤ì–´ìš”!**

---

## 2ï¸âƒ£ Reactì—ì„œ RPC í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°

### ìˆ˜ì • ì „ ì½”ë“œ (ì§ì ‘ í…Œì´ë¸” ìˆ˜ì • - ê¶Œí•œ ë¬¸ì œ ë°œìƒ!)
```typescript
// âŒ ì´ ë°©ë²•ì€ RLS(ë³´ì•ˆ ì •ì±…) ë•Œë¬¸ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ìš”
const { error } = await supabase
  .from("merits")
  .update({
    category: editCategory,
    reason: editReason,
    score: editScore
  })
  .eq("id", editingRecord.id);
```

### ìˆ˜ì • í›„ ì½”ë“œ (RPC í•¨ìˆ˜ í˜¸ì¶œ - ì•ˆì „!)
```typescript
// âœ… RPC í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ì•ˆì „í•˜ê²Œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”
const { error } = await supabase.rpc("teacher_update_merit", {
  teacher_id_input: teacherId,    // ë‚´ êµì‚¬ ID
  merit_id_input: editingRecord.id,  // ìˆ˜ì •í•  ê¸°ë¡ ID
  category_input: editCategory,   // ìƒˆ ì¹´í…Œê³ ë¦¬
  reason_input: editReason,       // ìƒˆ ì‚¬ìœ 
  score_input: editScore          // ìƒˆ ì ìˆ˜
});
```

### ğŸ” RPCë€?
RPCëŠ” **R**emote **P**rocedure **C**allì˜ ì•½ìì˜ˆìš”.
ì‰½ê²Œ ë§í•˜ë©´ "ì„œë²„ì— ìˆëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤"ëŠ” ëœ»ì´ì—ìš”.

```typescript
supabase.rpc("í•¨ìˆ˜ì´ë¦„", { 
  ë§¤ê°œë³€ìˆ˜1: ê°’1,
  ë§¤ê°œë³€ìˆ˜2: ê°’2 
});
```

### ì „ì²´ ìˆ˜ì • í•¸ë“¤ëŸ¬ ì½”ë“œ
```typescript
const handleSaveEdit = async () => {
  // ì…ë ¥ê°’ í™•ì¸
  if (!editingRecord || !editCategory.trim()) {
    toast.error("ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
    return;
  }

  setIsUpdating(true);  // ë¡œë”© ì‹œì‘

  try {
    let error = null;

    // ë ˆì½”ë“œ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ RPC í•¨ìˆ˜ í˜¸ì¶œ
    if (editingRecord.type === "merit") {
      const result = await supabase.rpc("teacher_update_merit", {
        teacher_id_input: teacherId,
        merit_id_input: editingRecord.id,
        category_input: editCategory.trim(),
        reason_input: editReason.trim(),
        score_input: editScore
      });
      error = result.error;
    } else if (editingRecord.type === "demerit") {
      const result = await supabase.rpc("teacher_update_demerit", {
        teacher_id_input: teacherId,
        demerit_id_input: editingRecord.id,
        category_input: editCategory.trim(),
        reason_input: editReason.trim(),
        score_input: editScore
      });
      error = result.error;
    } else {
      const result = await supabase.rpc("teacher_update_monthly", {
        teacher_id_input: teacherId,
        monthly_id_input: editingRecord.id,
        category_input: editCategory.trim(),
        reason_input: editReason.trim()
      });
      error = result.error;
    }

    if (error) throw error;

    toast.success("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤");
    setIsEditDialogOpen(false);  // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    onRefresh();  // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  } catch (error: any) {
    toast.error(error.message || "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
  } finally {
    setIsUpdating(false);  // ë¡œë”© ë
  }
};
```

---

## 3ï¸âƒ£ í…Œì´ë¸”ì—ì„œ ì»¬ëŸ¼ ì œê±°í•˜ê¸°

### ìš”êµ¬ì‚¬í•­
í•™ìƒ ëŒ€ì‹œë³´ë“œì˜ ë²Œì  ëª©ë¡ì—ì„œ **êµì‚¬ ì´ë¦„**ì„ ë³´ì´ì§€ ì•Šê²Œ í•´ì£¼ì„¸ìš”.

### ìˆ˜ì • ì „ ì½”ë“œ
```tsx
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>ë‚ ì§œ</TableHead>
      <TableHead>êµì‚¬</TableHead>        {/* â† ì´ ì¤„ì„ ì‚­ì œ */}
      <TableHead>ì¹´í…Œê³ ë¦¬</TableHead>
      <TableHead>ì‚¬ìœ </TableHead>
      <TableHead>ì ìˆ˜</TableHead>
      <TableHead>ì¦ë¹™ ì‚¬ì§„</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    {demerits.map((demerit, idx) => (
      <TableRow key={idx}>
        <TableCell>{new Date(demerit.created_at).toLocaleDateString()}</TableCell>
        <TableCell>{demerit.teacher_name || "-"}</TableCell>  {/* â† ì´ ì¤„ë„ ì‚­ì œ */}
        <TableCell>{demerit.category}</TableCell>
        <TableCell>{demerit.reason || "-"}</TableCell>
        <TableCell>{demerit.score}</TableCell>
        <TableCell>...</TableCell>
      </TableRow>
    ))}
  </TableBody>
</Table>
```

### ìˆ˜ì • í›„ ì½”ë“œ
```tsx
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>ë‚ ì§œ</TableHead>
      {/* êµì‚¬ ì»¬ëŸ¼ ì‚­ì œë¨ */}
      <TableHead>ì¹´í…Œê³ ë¦¬</TableHead>
      <TableHead>ì‚¬ìœ </TableHead>
      <TableHead>ì ìˆ˜</TableHead>
      <TableHead>ì¦ë¹™ ì‚¬ì§„</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    {demerits.length === 0 ? (
      <TableRow>
        <TableCell colSpan={5} className="text-center">  {/* 6ì—ì„œ 5ë¡œ ë³€ê²½ */}
          ë²Œì  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
        </TableCell>
      </TableRow>
    ) : (
      demerits.map((demerit, idx) => (
        <TableRow key={idx}>
          <TableCell>{new Date(demerit.created_at).toLocaleDateString()}</TableCell>
          {/* êµì‚¬ ì…€ ì‚­ì œë¨ */}
          <TableCell>{demerit.category}</TableCell>
          <TableCell>{demerit.reason || "-"}</TableCell>
          <TableCell>{demerit.score}</TableCell>
          <TableCell>...</TableCell>
        </TableRow>
      ))
    )}
  </TableBody>
</Table>
```

### ğŸ” ì£¼ì˜í•  ì 
| ë³€ê²½ ì‚¬í•­ | ì„¤ëª… |
|-----------|------|
| `<TableHead>êµì‚¬</TableHead>` ì‚­ì œ | í…Œì´ë¸” í—¤ë”ì—ì„œ êµì‚¬ ì»¬ëŸ¼ ì œê±° |
| `<TableCell>{demerit.teacher_name}</TableCell>` ì‚­ì œ | í…Œì´ë¸” ë°”ë””ì—ì„œ êµì‚¬ ì…€ ì œê±° |
| `colSpan={6}` â†’ `colSpan={5}` | ë¹ˆ í–‰ì´ ì°¨ì§€í•˜ëŠ” ì»¬ëŸ¼ ìˆ˜ ì¡°ì • |

---

## ğŸ“ ì˜¤ëŠ˜ì˜ í•µì‹¬ ì •ë¦¬

### 1. ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ (RPC)
- ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì•ˆì „í•œ í•¨ìˆ˜
- `SECURITY DEFINER`ë¡œ ë³´ì•ˆ ì„¤ì •
- ê¶Œí•œ í™•ì¸ í›„ ì‘ì—… ìˆ˜í–‰

### 2. Reactì—ì„œ RPC í˜¸ì¶œ
```typescript
const { data, error } = await supabase.rpc("í•¨ìˆ˜ì´ë¦„", {
  ë§¤ê°œë³€ìˆ˜: ê°’
});
```

### 3. í…Œì´ë¸” ì»¬ëŸ¼ ì œê±°
- `<TableHead>` ì‚­ì œ
- `<TableCell>` ì‚­ì œ  
- `colSpan` ìˆ«ì ì¡°ì •

---

## ğŸ¯ ì‹¤ìŠµ ê³¼ì œ

1. ìƒì  ëª©ë¡ì—ì„œë„ êµì‚¬ ì»¬ëŸ¼ì„ ì œê±°í•´ë³´ì„¸ìš”.
2. ì´ë‹¬ì˜ í•™ìƒ ëª©ë¡ì—ì„œë„ êµì‚¬ ì»¬ëŸ¼ì„ ì œê±°í•´ë³´ì„¸ìš”.
3. ìƒˆë¡œìš´ RPC í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ ê²½ë¡œ | ì„¤ëª… |
|-----------|------|
| `supabase/migrations/20251213072739_*.sql` | êµì‚¬ ìˆ˜ì •/ì‚­ì œ RPC í•¨ìˆ˜ ì¶”ê°€ |
| `src/components/teacher/TeacherRecordsList.tsx` | RPC í•¨ìˆ˜ í˜¸ì¶œë¡œ ë³€ê²½ |
| `src/pages/student/Dashboard.tsx` | ë²Œì  ëª©ë¡ì—ì„œ êµì‚¬ ì»¬ëŸ¼ ì œê±° |
