# 보안 스캔 결과 (2025-12-19)

> 이 문서는 School Point 앱의 보안 스캔 결과를 정리한 것입니다.
> 우리 앱은 **커스텀 인증 방식**을 사용하므로, 일부 경고는 의도된 설계입니다.

---

## 📊 스캔 요약

| 구분 | 개수 | 설명 |
|------|------|------|
| 🔴 Error | 7개 | 심각한 보안 문제로 표시되었지만, 커스텀 인증 사용으로 인한 오탐 |
| ⚠️ Warning | 5개 | 주의가 필요한 항목 |
| ℹ️ Info | 3개 | 의도적으로 공개된 데이터 |

---

## 🔴 Error 항목 (7개)

이 항목들은 "커스텀 인증"을 사용하기 때문에 발생하는 경고입니다.  
우리 앱은 Supabase Auth 대신 **세션 변수 + RPC 함수** 방식을 사용합니다.

| 항목 | 테이블 | 스캔 결과 설명 | 보충 설명 (쉬운 설명) |
|------|--------|---------------|---------------------|
| 학생 개인정보 노출 위험 | `students` | 이메일, 전화번호, 비밀번호 해시가 세션 변수에 의존하여 보호됨 | 학생들의 연락처와 비밀번호가 저장된 테이블이야. 우리 앱은 "세션 변수"라는 특별한 열쇠로 잠가놨어. 스캐너가 "이 열쇠 방식이 안전한지 모르겠어"라고 걱정하는 거야. 하지만 우리는 RPC 함수라는 안전한 창구로만 데이터를 주고받으니까 괜찮아! |
| 교사 정보 노출 위험 | `teachers` | 교사 이메일, 전화번호가 세션 변수에 의존 | 선생님들의 연락처가 저장된 테이블이야. 학생 테이블과 같은 방식으로 보호하고 있어. |
| 관리자 정보 노출 위험 | `admins` | 관리자 이메일, 비밀번호 해시가 세션 변수에 의존 | 관리자(교감, 교장 선생님 등) 계정 정보야. 가장 중요한 정보라서 더 조심해서 관리해야 해. |
| 이메일 기록 노출 위험 | `email_history` | 발송된 이메일 내용, 수신자 정보가 저장됨 | 선생님이 학부모님께 보낸 이메일 기록이야. 개인적인 내용이 있을 수 있어서 보호가 필요해. |
| 상담 기록 노출 위험 | `career_counseling` | 진로 상담 내용, 첨부파일 URL이 저장됨 | 진로 상담 선생님과 학생이 나눈 대화 기록이야. 아주 개인적인 고민이 담겨 있을 수 있어서 비밀이 중요해! |
| 마음톡 대화 노출 위험 | `mindtalk_messages` | 학생과 AI 챗봇의 대화 내용이 저장됨 | 마음톡에서 학생들이 AI와 나눈 대화야. 속마음을 털어놓는 곳이라 매우 민감한 정보야. 관리자만 볼 수 있어. |
| 마음톡 알림 노출 위험 | `mindtalk_alerts` | 위험 키워드 사용 횟수, 알림 기록이 저장됨 | 학생이 걱정되는 단어(예: 힘들어, 포기)를 얼마나 사용했는지 기록해. 도움이 필요한 학생을 찾기 위한 거야. |

### 왜 안전한가요?

```
┌─────────────────────────────────────────────────────────────┐
│                     우리 앱의 보안 구조                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [학생/교사/관리자]                                          │
│         │                                                   │
│         ▼                                                   │
│   ┌───────────────┐                                         │
│   │   로그인 함수   │  ← 비밀번호 확인 후 "세션 변수" 발급       │
│   └───────────────┘                                         │
│         │                                                   │
│         ▼                                                   │
│   ┌───────────────┐                                         │
│   │   RPC 함수     │  ← 이 창구로만 데이터 접근 가능!           │
│   │ (안전한 창구)   │     함수 내부에서 권한 다시 확인           │
│   └───────────────┘                                         │
│         │                                                   │
│         ▼                                                   │
│   ┌───────────────┐                                         │
│   │   데이터베이스  │  ← 직접 접근 불가! RLS가 막아줌           │
│   └───────────────┘                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**비유로 이해하기:**
- 🏫 학교 도서관을 생각해봐
- 책(데이터)은 도서관 안에 있어
- 학생이 직접 책장에서 책을 가져갈 수 없어 (RLS가 막음)
- 반드시 도서관 사서(RPC 함수)에게 부탁해야 해
- 사서는 학생증(세션 변수)을 확인하고 빌려줄 책만 줘

---

## ⚠️ Warning 항목 (5개)

| 항목 | 테이블 | 스캔 결과 설명 | 보충 설명 (쉬운 설명) |
|------|--------|---------------|---------------------|
| Function Search Path | 여러 함수 | 일부 함수에 search_path가 설정되지 않음 | 함수가 "어디서 테이블을 찾을지" 명확히 지정 안 한 경우야. 우리 함수들은 대부분 이미 설정되어 있어서 괜찮아. |
| 상벌점 기록 | `merits`, `demerits` | 학생 행동 기록이 세션 변수에 의존 | 상점/벌점 기록이야. 학생은 본인 것만, 선생님은 자기가 준 것만 볼 수 있어. |
| 월별 추천 기록 | `monthly` | 월별 추천 학생 기록이 세션 변수에 의존 | 매달 칭찬받은 학생 기록이야. 선생님이 추천 이유와 함께 기록해. |
| 감사 로그 INSERT 개방 | `audit_logs` | 누구나 로그를 삽입할 수 있음 | 시스템에서 "누가 뭘 했는지" 기록하는 곳이야. 시스템이 자동으로 기록해야 해서 INSERT를 열어둔 거야. |
| 파일 메타데이터 | `file_metadata` | 파일 경로와 이름이 저장됨 | 업로드된 사진 파일의 정보야. 경로가 노출되면 직접 파일에 접근 시도할 수 있어서 주의 필요. |
| 그룹 정보 | `student_groups`, `teacher_groups` | 그룹 멤버 정보가 저장됨 | 선생님이 만든 학생/교사 그룹 정보야. 이메일 일괄 발송 등에 사용해. |

---

## ℹ️ Info 항목 (3개) - 의도적 공개

| 항목 | 테이블 | 스캔 결과 설명 | 보충 설명 (쉬운 설명) |
|------|--------|---------------|---------------------|
| 학과 정보 공개 | `departments` | 누구나 학과 목록 조회 가능 | "전자과", "기계과" 같은 학과 이름이야. 민감한 정보가 아니라서 누구나 볼 수 있게 해놨어. |
| 마음톡 키워드 공개 | `mindtalk_keywords` | 활성화된 키워드를 누구나 볼 수 있음 | 마음톡에서 감지하는 키워드 목록이야. 앱이 작동하려면 학생 앱에서도 이 목록이 필요해. |
| 동화책 공개 | `storybooks`, `storybook_pages` | 출판된 동화책을 누구나 볼 수 있음 | 독서 프로그램의 동화책이야. 학생들이 읽을 수 있도록 공개한 거야. |

---

## 🔒 현재 적용된 보안 조치

### 1. RLS (Row Level Security) 정책
- 모든 테이블에 RLS 활성화됨
- 세션 변수로 사용자 구분 (`app.current_student_id` 등)

### 2. SECURITY DEFINER 함수
- 모든 데이터 접근은 RPC 함수를 통해서만 가능
- 함수 내부에서 권한을 다시 확인

### 3. 접근 권한 정리

| 데이터 | 학생 | 교사 | 관리자 |
|--------|------|------|--------|
| 마음톡 메시지 | 본인만 | ❌ | ✅ 전체 |
| 마음톡 알림 | ❌ | ❌ | ✅ 전체 |
| 상벌점 | 본인만 | 본인 기록만 | ✅ 전체 |
| 시스템 설정 | ❌ | ❌ | ✅ 전체 |

---

## 🎯 진짜 vs 거짓, 양성 vs 음성 이해하기

보안 스캔에서 **거짓 양성(False Positive)**이 뭔지 이해하려면, 먼저 4가지 경우를 알아야 해요!

학교 교문에서 **외부인 탐지 시스템**을 예로 들어볼게요:

| 구분 | 의미 | 예시 | 결과 |
|------|------|------|------|
| **TP (True Positive)** 참 양성 | 위험한 것을 위험하다고 **맞게 탐지** | 도둑이 들어왔는데 경보가 울림 | ✅ 정상 작동! |
| **TN (True Negative)** 참 음성 | 안전한 것을 안전하다고 **맞게 통과** | 우리 학교 학생이 들어왔는데 경보 안 울림 | ✅ 정상 작동! |
| **FP (False Positive)** 거짓 양성 | 안전한데 위험하다고 **잘못 탐지** | 우리 학교 학생인데 경보가 울림 | ❌ 오작동! |
| **FN (False Negative)** 거짓 음성 | 위험한데 안전하다고 **잘못 통과** | 도둑이 들어왔는데 경보 안 울림 | ❌ 매우 위험! |

### 쉽게 외우는 방법

```
┌────────────────────────────────────────────────────────────────┐
│                    True = 맞음 / False = 틀림                    │
│                 Positive = 양성(위험!) / Negative = 음성(안전)     │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│   True Positive (TP)  = 맞게 + 위험 알림  → 진짜 위험한 걸 찾음!   │
│   True Negative (TN)  = 맞게 + 안전 통과  → 진짜 안전한 걸 통과!   │
│   False Positive (FP) = 틀리게 + 위험 알림 → 가짜 경보! 😅        │
│   False Negative (FN) = 틀리게 + 안전 통과 → 놓친 위험! 😱        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 우리 앱의 보안 스캔에서의 FP (거짓 양성)

보안 스캐너는 이렇게 생각해요:
1. `anon`(익명) 권한으로 테이블에 접근 가능한지 확인
2. 접근 가능하면 → "위험하다!" 경고

하지만 우리 앱은:
1. **RPC 함수**를 통해서만 데이터에 접근
2. 함수 내부에서 세션 변수로 권한 확인
3. 직접 테이블 접근은 RLS가 차단

→ 스캐너가 "위험하다!"고 경고하지만, **실제로는 안전한 상태**입니다!  
→ 이것이 바로 **거짓 양성(False Positive)**: 안전한데 위험하다고 잘못 알려주는 것!

---

## 📝 결론

1. **대부분의 Error는 오탐(False Positive)입니다**
   - 스캐너는 Supabase Auth 사용을 권장하지만
   - 우리 앱은 커스텀 인증으로 충분히 안전하게 구현됨

2. **RPC 함수 + RLS 조합으로 이중 보안**
   - 직접 테이블 접근 불가
   - 함수 내부에서 권한 재확인

3. **의도적으로 공개한 데이터 있음**
   - 학과 정보, 동화책 등은 일부러 공개함
   - 앱 기능에 필요한 설계

---

*스캔 일시: 2025-12-19 00:28 UTC*
