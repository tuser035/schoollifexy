# Supabase 정책(Policy)과 권한(Permission) 이해하기

> 작성일: 2025-12-15  
> 대상: 중학생 수준의 초보 개발자  
> 주제: Row Level Security(RLS) 정책과 역할(Role) 기반 권한

---

## 📚 학습 목표

이 문서를 읽고 나면 다음을 이해할 수 있어요:
1. RLS 정책이 무엇이고 왜 필요한지
2. Supabase의 역할(Role) 시스템
3. 우리 앱에서 실제로 사용된 정책 예시
4. Storage 정책과 테이블 정책의 차이

---

## 1. RLS란 무엇인가요?

### Row Level Security (행 수준 보안)

```
┌─────────────────────────────────────────────────────────┐
│                    데이터베이스                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │              students 테이블                     │   │
│  │  ┌─────────────────────────────────────────┐    │   │
│  │  │ 학번: 10101 | 이름: 김철수 | 반: 1-1   │ ← 철수만 볼 수 있음   │
│  │  │ 학번: 10102 | 이름: 이영희 | 반: 1-1   │ ← 영희만 볼 수 있음   │
│  │  │ 학번: 10103 | 이름: 박민수 | 반: 1-2   │ ← 민수만 볼 수 있음   │
│  │  └─────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  RLS = "각 행(Row)마다 누가 볼 수 있는지 정하는 규칙"    │
└─────────────────────────────────────────────────────────┘
```

### 비유: 학교 사물함

```
🏫 학교 사물함 시스템

사물함 1번 (철수)     사물함 2번 (영희)     사물함 3번 (민수)
   🔒                    🔒                    🔒
   
- 철수는 1번만 열 수 있음
- 영희는 2번만 열 수 있음  
- 선생님은 모든 사물함을 열 수 있음
- 교장선생님도 모든 사물함을 열 수 있음

이것이 바로 RLS의 개념이에요!
```

---

## 2. 역할(Role)이란?

### Supabase의 주요 역할

| 역할 | 설명 | 우리 앱에서 |
|------|------|------------|
| `anon` | 로그인하지 않은 사람 | 로그인 화면 접속자 |
| `authenticated` | Supabase Auth로 로그인한 사람 | (우리 앱은 사용 안 함) |
| `service_role` | 모든 권한을 가진 관리자 | Edge Function에서 사용 |
| `public` | 기본 역할 | 정책에서 자주 사용 |

### 우리 앱의 커스텀 역할 시스템

```
우리 앱은 Supabase Auth 대신 커스텀 인증을 사용해요!

┌─────────────────────────────────────────────────────────┐
│                    세션 변수 방식                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  👨‍🎓 학생 로그인 시:                                    │
│     → app.current_student_id = "10101"                 │
│                                                         │
│  👨‍🏫 교사 로그인 시:                                    │
│     → app.current_teacher_id = "uuid-xxx-xxx"          │
│                                                         │
│  👨‍💼 관리자 로그인 시:                                  │
│     → app.current_admin_id = "uuid-yyy-yyy"            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 실제 정책 예시 분석

### 예시 1: 학생은 자기 정보만 볼 수 있음

```sql
-- students 테이블의 SELECT 정책
CREATE POLICY "students_select_own" 
ON students 
FOR SELECT                                    -- 조회(SELECT)할 때
USING (
  current_setting('app.current_student_id', true) IS NOT NULL  -- 학생 세션이 있고
  AND 
  student_id = current_setting('app.current_student_id', true) -- 자기 학번과 일치할 때만
);
```

**쉽게 설명하면:**
```
학생 김철수(10101)가 데이터를 요청했을 때:

요청: SELECT * FROM students;

┌──────────────────────────────────────────┐
│ RLS 검사                                  │
│                                          │
│ 10101 행: student_id = '10101' ✅ 통과!  │
│ 10102 행: student_id = '10102' ❌ 차단!  │
│ 10103 행: student_id = '10103' ❌ 차단!  │
└──────────────────────────────────────────┘

결과: 철수는 자기 정보(10101)만 받음
```

### 예시 2: 교사는 모든 학생을 볼 수 있음

```sql
-- students 테이블의 교사용 SELECT 정책
CREATE POLICY "teachers_select_all_students" 
ON students 
FOR SELECT
USING (
  current_setting('app.current_teacher_id', true) IS NOT NULL  -- 교사 세션만 있으면
  AND 
  current_setting('app.current_teacher_id', true) <> ''::text  -- 비어있지 않으면
);
-- 조건에 student_id 비교가 없음 = 모든 행 통과!
```

**쉽게 설명하면:**
```
교사 이정원이 데이터를 요청했을 때:

요청: SELECT * FROM students;

┌──────────────────────────────────────────┐
│ RLS 검사                                  │
│                                          │
│ 10101 행: 교사 세션 있음? ✅ 통과!        │
│ 10102 행: 교사 세션 있음? ✅ 통과!        │
│ 10103 행: 교사 세션 있음? ✅ 통과!        │
└──────────────────────────────────────────┘

결과: 선생님은 모든 학생 정보를 받음
```

### 예시 3: 교사는 자기가 입력한 상벌점만 삭제 가능

```sql
-- merits 테이블의 DELETE 정책
CREATE POLICY "Teachers can delete own merits" 
ON merits 
FOR DELETE
USING (
  teacher_id IS NOT NULL                                        -- teacher_id가 있고
  AND 
  (teacher_id)::text = current_setting('app.current_teacher_id', true)  -- 본인이 입력한 것만
);
```

**쉽게 설명하면:**
```
교사 A가 입력한 상점:  teacher_id = 'A의 UUID'
교사 B가 입력한 상점:  teacher_id = 'B의 UUID'

교사 A가 삭제를 시도할 때:
- 교사 A의 상점 → ✅ 삭제 가능
- 교사 B의 상점 → ❌ 삭제 불가 (권한 없음 에러)
```

---

## 4. 정책의 4가지 명령어

```sql
┌─────────────────────────────────────────────────────────┐
│              RLS 정책이 적용되는 4가지 명령              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📖 SELECT  - 데이터 조회                               │
│     → USING (조건)  : 이 조건을 만족하는 행만 보여줌     │
│                                                         │
│  ➕ INSERT  - 데이터 추가                               │
│     → WITH CHECK (조건) : 이 조건을 만족해야 추가 가능   │
│                                                         │
│  ✏️ UPDATE  - 데이터 수정                               │
│     → USING (조건)  : 이 조건을 만족하는 행만 수정 가능  │
│                                                         │
│  🗑️ DELETE  - 데이터 삭제                               │
│     → USING (조건)  : 이 조건을 만족하는 행만 삭제 가능  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 실제 코드 예시

```sql
-- 상벌점 테이블의 완전한 정책 세트

-- 1. 학생은 자기 상점만 조회
CREATE POLICY "Students can view own merits" 
ON merits FOR SELECT
USING (student_id = current_setting('app.current_student_id', true));

-- 2. 교사는 상점 추가 가능 (본인 ID로만)
CREATE POLICY "Teachers can insert merits" 
ON merits FOR INSERT
WITH CHECK (
  teacher_id IS NOT NULL 
  AND (teacher_id)::text = current_setting('app.current_teacher_id', true)
);

-- 3. 관리자는 모든 상점 수정 가능
CREATE POLICY "Admins can update merits" 
ON merits FOR UPDATE
USING (
  current_setting('app.current_admin_id', true) IS NOT NULL
);

-- 4. 교사는 본인이 입력한 상점만 삭제 가능
CREATE POLICY "Teachers can delete own merits" 
ON merits FOR DELETE
USING (
  (teacher_id)::text = current_setting('app.current_teacher_id', true)
);
```

---

## 5. Storage 정책 (파일 저장소)

### 테이블 정책 vs Storage 정책

```
┌─────────────────────────────────────────────────────────┐
│                      차이점                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📊 테이블 정책 (students, merits 등)                   │
│     → 세션 변수 사용 가능                               │
│     → current_setting('app.current_teacher_id')        │
│     → RPC 함수가 세션을 설정해줌                        │
│                                                         │
│  📁 Storage 정책 (파일 업로드/다운로드)                 │
│     → 세션 변수 사용 어려움                             │
│     → 직접 API 호출이라 RPC를 거치지 않음               │
│     → 역할(Role)로 직접 제어해야 함                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Storage 정책 예시

```sql
-- 이메일 첨부파일 버킷에 업로드 허용
CREATE POLICY "email_attachments_insert_anon"
ON storage.objects 
FOR INSERT
TO anon                                    -- anon 역할에게
WITH CHECK (bucket_id = 'email-attachments');  -- 이 버킷에만 허용

-- 이메일 첨부파일 버킷에서 다운로드 허용
CREATE POLICY "email_attachments_select_anon"
ON storage.objects 
FOR SELECT
TO anon                                    -- anon 역할에게
USING (bucket_id = 'email-attachments');   -- 이 버킷에서만 허용
```

### 왜 anon 역할이 필요한가요?

```
우리 앱의 파일 업로드 흐름:

1. 교사가 파일 첨부 버튼 클릭
2. 브라우저에서 Supabase Storage API 직접 호출
   └── 이 때 사용되는 역할: anon (세션 변수 없음!)
3. Storage가 RLS 정책 검사
   └── "anon 역할이 이 버킷에 업로드할 수 있나요?"
4. 정책 통과 시 파일 저장

문제: 우리는 커스텀 인증을 사용하므로
      Supabase는 "로그인 안 한 사람(anon)"으로 인식함
      
해결: anon 역할에게 특정 버킷 접근 권한 부여
```

---

## 6. 정책 작성 패턴

### 패턴 1: 본인만 접근

```sql
-- "나만 내 데이터를 볼 수 있음"
USING (
  (id)::text = current_setting('app.current_xxx_id', true)
)
```

### 패턴 2: 특정 역할 전체 접근

```sql
-- "교사면 모두 볼 수 있음"
USING (
  current_setting('app.current_teacher_id', true) IS NOT NULL
  AND current_setting('app.current_teacher_id', true) <> ''
)
```

### 패턴 3: 모든 사람 접근 (공개)

```sql
-- "누구나 볼 수 있음"
USING (true)
```

### 패턴 4: 역할 기반 (Storage용)

```sql
-- "anon과 authenticated 역할에게 허용"
TO anon, authenticated
```

---

## 7. 자주 하는 실수

### ❌ 실수 1: TO public으로 모든 사람에게 허용했다고 생각

```sql
-- 이렇게 하면 모든 사람이 접근할 수 있을까요?
CREATE POLICY "Allow all" ON storage.objects
TO public                    -- ⚠️ public ≠ 모든 사람!
WITH CHECK (true);

-- public은 "인증된 데이터베이스 역할"을 의미
-- anon(익명)은 포함되지 않을 수 있음!
```

### ✅ 올바른 방법

```sql
-- anon 역할을 명시적으로 지정
CREATE POLICY "Allow anon" ON storage.objects
TO anon                      -- ✅ anon 명시
WITH CHECK (true);
```

### ❌ 실수 2: INSERT에 USING 사용

```sql
-- INSERT에는 USING을 쓸 수 없어요!
CREATE POLICY "Wrong policy" ON students
FOR INSERT
USING (xxx);                 -- ❌ 에러!

-- INSERT는 WITH CHECK를 사용해야 해요
CREATE POLICY "Correct policy" ON students
FOR INSERT
WITH CHECK (xxx);            -- ✅ 올바름!
```

---

## 8. 연습 문제

### 문제 1
다음 정책이 어떤 역할을 하는지 설명하세요.

```sql
CREATE POLICY "policy1" ON demerits
FOR SELECT
USING (student_id = current_setting('app.current_student_id', true));
```

<details>
<summary>정답 보기</summary>
학생은 자기 학번(student_id)과 일치하는 벌점 기록만 조회할 수 있습니다.
다른 학생의 벌점은 볼 수 없습니다.
</details>

### 문제 2
교사가 자기가 입력한 추천서만 수정할 수 있게 하는 정책을 작성하세요.

<details>
<summary>정답 보기</summary>

```sql
CREATE POLICY "Teachers can update own monthly" 
ON monthly 
FOR UPDATE
USING (
  teacher_id IS NOT NULL
  AND (teacher_id)::text = current_setting('app.current_teacher_id', true)
);
```
</details>

### 문제 3
Storage 정책에서 `TO anon`이 필요한 이유는?

<details>
<summary>정답 보기</summary>
우리 앱은 커스텀 인증을 사용하기 때문에 Supabase는 사용자를 "인증되지 않은 사람(anon)"으로 인식합니다.
Storage API를 직접 호출할 때는 RPC 함수를 거치지 않으므로 세션 변수가 설정되지 않습니다.
따라서 anon 역할에게 명시적으로 권한을 부여해야 파일 업로드/다운로드가 가능합니다.
</details>

---

## 9. 핵심 정리

1. **RLS = 행 수준 보안**: 각 행마다 "누가 접근할 수 있는지" 정하는 규칙
2. **USING vs WITH CHECK**: SELECT/UPDATE/DELETE는 USING, INSERT는 WITH CHECK
3. **세션 변수**: `current_setting('app.current_xxx_id')` 로 현재 사용자 확인
4. **역할(Role)**: anon, authenticated, public 등 - Storage 정책에서 중요
5. **Storage는 특별**: 세션 변수를 못 쓰므로 역할로 직접 제어

---

## 📖 더 알아보기

- [Supabase RLS 공식 문서](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL CREATE POLICY](https://www.postgresql.org/docs/current/sql-createpolicy.html)
- [Supabase Storage 보안](https://supabase.com/docs/guides/storage/security/access-control)
