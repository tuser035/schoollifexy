# RLS 정책 전체 목록 (2025-12-19)

> 이 문서는 School Point 앱의 모든 테이블에 적용된 Row Level Security(RLS) 정책을 정리한 것입니다.

---

## 📋 목차

1. [학생 관련 테이블](#학생-관련-테이블)
2. [교사 관련 테이블](#교사-관련-테이블)
3. [관리자 관련 테이블](#관리자-관련-테이블)
4. [상벌점 관련 테이블](#상벌점-관련-테이블)
5. [마음톡 관련 테이블](#마음톡-관련-테이블)
6. [동화책 관련 테이블](#동화책-관련-테이블)
7. [이메일 관련 테이블](#이메일-관련-테이블)
8. [그룹/기타 테이블](#그룹기타-테이블)

---

## 학생 관련 테이블

### 📚 students (학생 정보)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all students` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 학생 정보를 볼 수 있어요 |
| `Admins can insert students` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자만 학생을 등록할 수 있어요 |
| `Admins can update students` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 학생 정보를 수정할 수 있어요 |
| `Admins can delete students` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 학생을 삭제할 수 있어요 |
| `students_select_own` | SELECT | `student_id = app.current_student_id` | 학생은 본인 정보만 볼 수 있어요 |
| `teachers_select_all_students` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 모든 학생 정보를 볼 수 있어요 |

---

## 교사 관련 테이블

### 👨‍🏫 teachers (교사 정보)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all teachers` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 교사 정보를 볼 수 있어요 |
| `Admins can insert teachers` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자만 교사를 등록할 수 있어요 |
| `Admins can update teachers` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 교사 정보를 수정할 수 있어요 |
| `Admins can delete teachers` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 교사를 삭제할 수 있어요 |
| `Teachers can view all teachers` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 다른 교사 정보를 볼 수 있어요 |
| `Students can view teachers` | SELECT | `app.current_student_id IS NOT NULL` | 학생도 교사 정보를 볼 수 있어요 |

---

## 관리자 관련 테이블

### 👑 admins (관리자 정보)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `admins_select_own` | SELECT | `id = app.current_admin_id` | 관리자는 본인 정보만 볼 수 있어요 |

> ⚠️ INSERT, UPDATE, DELETE 불가 - 관리자 계정은 직접 생성/수정/삭제할 수 없어요

---

## 상벌점 관련 테이블

### ⭐ merits (상점)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all merits` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 상점을 볼 수 있어요 |
| `Admins can insert merits` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자는 상점을 추가할 수 있어요 |
| `Admins can update merits` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자는 상점을 수정할 수 있어요 |
| `Admins can delete merits` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자는 상점을 삭제할 수 있어요 |
| `Teachers can view all merits` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 모든 상점을 볼 수 있어요 |
| `Teachers can view merits` | SELECT | `app.current_teacher_id OR app.current_admin_id` | 교사/관리자 상점 조회 |
| `Teachers can insert merits` | INSERT | `teacher_id = app.current_teacher_id` | 교사는 본인 명의로 상점을 줄 수 있어요 |
| `Teachers can delete own merits` | DELETE | `teacher_id = app.current_teacher_id` | 교사는 본인이 준 상점만 삭제할 수 있어요 |
| `Students can view own merits` | SELECT | `student_id = app.current_student_id` | 학생은 본인 상점만 볼 수 있어요 |

### ❌ demerits (벌점)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all demerits` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 벌점을 볼 수 있어요 |
| `Admins can insert demerits` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자는 벌점을 추가할 수 있어요 |
| `Admins can update demerits` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자는 벌점을 수정할 수 있어요 |
| `Admins can delete demerits` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자는 벌점을 삭제할 수 있어요 |
| `Teachers can view all demerits` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 모든 벌점을 볼 수 있어요 |
| `Teachers can view demerits` | SELECT | `app.current_teacher_id OR app.current_admin_id` | 교사/관리자 벌점 조회 |
| `Teachers can insert demerits` | INSERT | `teacher_id = app.current_teacher_id` | 교사는 본인 명의로 벌점을 줄 수 있어요 |
| `Teachers can delete own demerits` | DELETE | `teacher_id = app.current_teacher_id` | 교사는 본인이 준 벌점만 삭제할 수 있어요 |
| `Students can view own demerits` | SELECT | `student_id = app.current_student_id` | 학생은 본인 벌점만 볼 수 있어요 |

---

## 마음톡 관련 테이블

### 💬 mindtalk_messages (마음톡 대화)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all mindtalk messages` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 학생의 마음톡 대화를 볼 수 있어요 |
| `Students can view own mindtalk messages` | SELECT | `student_id = app.current_student_id` | 학생은 본인 대화만 볼 수 있어요 |
| `Students can insert own mindtalk messages` | INSERT | `student_id = app.current_student_id` | 학생은 본인 대화만 저장할 수 있어요 |

> ⚠️ UPDATE, DELETE 불가 - 대화 기록은 수정/삭제할 수 없어요 (기록 보존)

### ⚠️ mindtalk_alerts (마음톡 알림)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all alerts` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자만 알림 기록을 볼 수 있어요 |

> 학생/교사는 알림 기록을 볼 수 없어요

### 🔑 mindtalk_keywords (마음톡 키워드)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can manage keywords` | ALL | `app.current_admin_id IS NOT NULL` | 관리자는 키워드를 관리할 수 있어요 |
| `Public can view active keywords` | SELECT | `is_active = true` | 활성화된 키워드는 누구나 볼 수 있어요 |
| `Students can view keywords` | SELECT | `app.current_student_id IS NOT NULL` | 학생은 키워드를 볼 수 있어요 |
| `Teachers can view keywords` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 키워드를 볼 수 있어요 |

### 🎵 mindtalk_music (마음톡 음악)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can manage music` | ALL | `app.current_admin_id IS NOT NULL` | 관리자는 음악을 관리할 수 있어요 |
| `Students can view active music` | SELECT | `is_active = true` | 학생은 활성화된 음악만 볼 수 있어요 |

### 🎧 mindtalk_play_history (음악 재생 기록)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Students can view own history` | SELECT | `student_id = app.current_student_id` | 학생은 본인 재생 기록만 볼 수 있어요 |
| `Students can insert own history` | INSERT | `student_id = app.current_student_id` | 학생은 본인 재생 기록만 저장할 수 있어요 |

> ⚠️ UPDATE, DELETE 불가

### 📝 mindtalk_playlists (플레이리스트)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Students can view own playlists` | SELECT | `student_id = app.current_student_id` | 학생은 본인 플레이리스트만 볼 수 있어요 |
| `Students can insert own playlists` | INSERT | `student_id = app.current_student_id` | 학생은 본인 플레이리스트만 만들 수 있어요 |
| `Students can update own playlists` | UPDATE | `student_id = app.current_student_id` | 학생은 본인 플레이리스트만 수정할 수 있어요 |
| `Students can delete own playlists` | DELETE | `student_id = app.current_student_id` | 학생은 본인 플레이리스트만 삭제할 수 있어요 |

---

## 동화책 관련 테이블

### 📖 storybooks (동화책)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all storybooks` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 동화책을 볼 수 있어요 |
| `Admins can insert storybooks` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자만 동화책을 등록할 수 있어요 |
| `Admins can update storybooks` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 동화책을 수정할 수 있어요 |
| `Admins can delete storybooks` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 동화책을 삭제할 수 있어요 |
| `Anyone can view published storybooks` | SELECT | `is_published = true` | 출판된 동화책은 누구나 볼 수 있어요 |

### 📄 storybook_pages (동화책 페이지)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can insert storybook pages` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자만 페이지를 추가할 수 있어요 |
| `Admins can update storybook pages` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 페이지를 수정할 수 있어요 |
| `Admins can delete storybook pages` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 페이지를 삭제할 수 있어요 |
| `Anyone can view storybook pages` | SELECT | `book.is_published = true` | 출판된 동화책의 페이지는 누구나 볼 수 있어요 |

### 📑 storybook_reading_history (독서 기록)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Students can view own reading history` | SELECT | `student_id = app.current_student_id` | 학생은 본인 독서 기록만 볼 수 있어요 |
| `Students can insert own reading history` | INSERT | `student_id = app.current_student_id` | 학생은 본인 독서 기록만 저장할 수 있어요 |
| `Students can update own reading history` | UPDATE | `student_id = app.current_student_id` | 학생은 본인 독서 기록만 수정할 수 있어요 |

> ⚠️ DELETE 불가

### 🔖 storybook_page_bookmarks (책갈피)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Students can view own bookmarks` | SELECT | `student_id = app.current_student_id` | 학생은 본인 책갈피만 볼 수 있어요 |
| `Students can insert own bookmarks` | INSERT | `student_id = app.current_student_id` | 학생은 본인 책갈피만 추가할 수 있어요 |
| `Students can delete own bookmarks` | DELETE | `student_id = app.current_student_id` | 학생은 본인 책갈피만 삭제할 수 있어요 |

> ⚠️ UPDATE 불가

### ⭐ storybook_reviews (독서 감상문)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all reviews` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 감상문을 볼 수 있어요 |
| `Anyone can view public reviews` | SELECT | `is_public = true` | 공개된 감상문은 누구나 볼 수 있어요 |
| `Students can view own reviews` | SELECT | `student_id = app.current_student_id` | 학생은 본인 감상문을 볼 수 있어요 |
| `Students can insert own reviews` | INSERT | `student_id = app.current_student_id` | 학생은 본인 감상문만 작성할 수 있어요 |
| `Students can update own reviews` | UPDATE | `student_id = app.current_student_id` | 학생은 본인 감상문만 수정할 수 있어요 |
| `Students can delete own reviews` | DELETE | `student_id = app.current_student_id` | 학생은 본인 감상문만 삭제할 수 있어요 |

---

## 이메일 관련 테이블

### 📧 email_history (이메일 발송 기록)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all email history` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 이메일 기록을 볼 수 있어요 |
| `Admins can insert email history` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자는 이메일 기록을 저장할 수 있어요 |
| `Teachers can view own email history` | SELECT | `sender_id = app.current_teacher_id` | 교사는 본인이 보낸 이메일만 볼 수 있어요 |
| `Teachers can insert email history` | INSERT | `sender_id = app.current_teacher_id` | 교사는 본인 명의로 이메일 기록을 저장할 수 있어요 |

> ⚠️ UPDATE, DELETE 불가 - 이메일 기록은 보존됨

### 📝 email_templates (이메일 템플릿)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all email templates` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 템플릿을 볼 수 있어요 |
| `Admins can insert email templates` | INSERT | `admin_id = app.current_admin_id` | 관리자는 본인 명의로 템플릿을 만들 수 있어요 |
| `Admins can update email templates` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자는 템플릿을 수정할 수 있어요 |
| `Admins can delete email templates` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자는 템플릿을 삭제할 수 있어요 |
| `Teachers can view email templates` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 템플릿을 볼 수 있어요 |

---

## 그룹/기타 테이블

### 👥 student_groups (학생 그룹)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view own student groups` | SELECT | `admin_id = app.current_admin_id` | 관리자는 본인이 만든 그룹만 볼 수 있어요 |
| `Admins can insert student groups` | INSERT | `admin_id = app.current_admin_id` | 관리자는 본인 명의로 그룹을 만들 수 있어요 |
| `Admins can update own student groups` | UPDATE | `admin_id = app.current_admin_id` | 관리자는 본인 그룹만 수정할 수 있어요 |
| `Admins can delete all student groups` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자는 모든 그룹을 삭제할 수 있어요 |
| `Teachers can view own student groups` | SELECT | `admin_id = app.current_teacher_id` | 교사는 본인이 만든 그룹만 볼 수 있어요 |
| `Teachers can insert student groups` | INSERT | `admin_id = app.current_teacher_id` | 교사는 본인 명의로 그룹을 만들 수 있어요 |
| `Teachers can update own student groups` | UPDATE | `admin_id = app.current_teacher_id` | 교사는 본인 그룹만 수정할 수 있어요 |
| `Teachers can delete own student groups` | DELETE | `admin_id = app.current_teacher_id` | 교사는 본인 그룹만 삭제할 수 있어요 |

### 👨‍🏫 teacher_groups (교사 그룹)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view own teacher groups` | SELECT | `admin_id = app.current_admin_id` | 관리자는 본인이 만든 그룹만 볼 수 있어요 |
| `Admins can insert teacher groups` | INSERT | `admin_id = app.current_admin_id` | 관리자는 본인 명의로 그룹을 만들 수 있어요 |
| `Admins can update own teacher groups` | UPDATE | `admin_id = app.current_admin_id` | 관리자는 본인 그룹만 수정할 수 있어요 |
| `Admins can delete own teacher groups` | DELETE | `admin_id = app.current_admin_id` | 관리자는 본인 그룹만 삭제할 수 있어요 |
| `Teachers can view own teacher groups` | SELECT | `admin_id = app.current_teacher_id` | 교사는 본인이 만든 그룹만 볼 수 있어요 |
| `Teachers can insert teacher groups` | INSERT | `admin_id = app.current_teacher_id` | 교사는 본인 명의로 그룹을 만들 수 있어요 |
| `Teachers can update own teacher groups` | UPDATE | `admin_id = app.current_teacher_id` | 교사는 본인 그룹만 수정할 수 있어요 |
| `Teachers can delete own teacher groups` | DELETE | `admin_id = app.current_teacher_id` | 교사는 본인 그룹만 삭제할 수 있어요 |

### 🎓 career_counseling (진로 상담)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all counseling records` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 상담 기록을 볼 수 있어요 |
| `Admins and teachers can insert counseling records` | INSERT | `app.current_admin_id OR app.current_teacher_id` | 관리자/교사는 상담 기록을 추가할 수 있어요 |
| `Admins can update counseling records` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 상담 기록을 수정할 수 있어요 |
| `Admins can delete counseling records` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 상담 기록을 삭제할 수 있어요 |
| `Teachers can view all counseling records` | SELECT | `app.current_teacher_id IS NOT NULL` | 교사는 모든 상담 기록을 볼 수 있어요 |

### 🏢 departments (학과)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Anyone can view departments` | SELECT | `true` | 학과 정보는 누구나 볼 수 있어요 |
| `Admins can insert departments` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자만 학과를 추가할 수 있어요 |
| `Admins can update departments` | UPDATE | `app.current_admin_id IS NOT NULL` | 관리자만 학과를 수정할 수 있어요 |
| `Admins can delete departments` | DELETE | `app.current_admin_id IS NOT NULL` | 관리자만 학과를 삭제할 수 있어요 |

### 📁 file_metadata (파일 정보)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can read all file metadata` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자는 모든 파일 정보를 볼 수 있어요 |
| `Admins can view all file metadata` | SELECT | `app.current_admin_id IS NOT NULL` | (중복 정책) |
| `Admins can insert file metadata` | INSERT | `app.current_admin_id IS NOT NULL` | 관리자는 파일 정보를 추가할 수 있어요 |
| `Admins can delete file metadata` | DELETE | `admins.id = app.current_admin_id` | 관리자는 파일 정보를 삭제할 수 있어요 |
| `Teachers can view own file metadata` | SELECT | `uploaded_by = app.current_teacher_id` | 교사는 본인이 업로드한 파일만 볼 수 있어요 |
| `Teachers can insert file metadata` | INSERT | `uploaded_by = app.current_teacher_id` | 교사는 본인 명의로 파일 정보를 추가할 수 있어요 |

> ⚠️ UPDATE 불가

### 📋 audit_logs (감사 로그)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view all audit logs` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자만 감사 로그를 볼 수 있어요 |
| `System can insert audit logs` | INSERT | `true` | 시스템이 자동으로 로그를 기록해요 |

> ⚠️ UPDATE, DELETE 불가 - 로그는 변경/삭제할 수 없어요

### ⚙️ system_settings (시스템 설정)

| 정책명 | 명령 | 조건 | 조건 설명 |
|--------|------|------|----------|
| `Admins can view system settings` | SELECT | `app.current_admin_id IS NOT NULL` | 관리자만 시스템 설정을 볼 수 있어요 |
| `Admins can insert system settings` | INSERT | `admins.id = app.current_admin_id` | 관리자만 시스템 설정을 추가할 수 있어요 |
| `Admins can update system settings` | UPDATE | `admins.id = app.current_admin_id` | 관리자만 시스템 설정을 수정할 수 있어요 |

> ⚠️ DELETE 불가

---

## 📊 권한 요약표

| 데이터 | 학생 | 교사 | 관리자 |
|--------|------|------|--------|
| 학생 정보 | 본인만 | ✅ 전체 | ✅ 전체 + 수정/삭제 |
| 교사 정보 | ✅ 전체 (조회만) | ✅ 전체 | ✅ 전체 + 수정/삭제 |
| 관리자 정보 | ❌ | ❌ | 본인만 |
| 상/벌점 | 본인만 | ✅ 전체 + 본인 기록 관리 | ✅ 전체 + 수정/삭제 |
| 마음톡 대화 | 본인만 | ❌ | ✅ 전체 |
| 마음톡 알림 | ❌ | ❌ | ✅ 전체 |
| 동화책 | 출판된 것만 | 출판된 것만 | ✅ 전체 + 관리 |
| 독서 기록 | 본인만 | ❌ | ❌ |
| 이메일 기록 | ❌ | 본인 발송만 | ✅ 전체 |
| 그룹 | ❌ | 본인 생성만 | 본인 생성만 |
| 시스템 설정 | ❌ | ❌ | ✅ 전체 |
| 감사 로그 | ❌ | ❌ | ✅ 전체 (조회만) |

---

## 🔑 세션 변수 설명

| 변수명 | 설명 | 설정 시점 |
|--------|------|----------|
| `app.current_student_id` | 로그인한 학생의 학번 | 학생 로그인 시 |
| `app.current_teacher_id` | 로그인한 교사의 UUID | 교사 로그인 시 |
| `app.current_admin_id` | 로그인한 관리자의 UUID | 관리자 로그인 시 |

---

*문서 생성일: 2025-12-19*
