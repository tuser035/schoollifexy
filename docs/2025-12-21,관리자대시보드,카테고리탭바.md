# 2025-12-21 작업 기록: 시집(Poetry) 기능 통합

## 📚 오늘 배울 내용
- React에서 여러 데이터 소스를 하나로 합치는 방법
- 조건문(if-else)으로 다른 동작 처리하기
- 버튼 UI 추가하기

---

## 🎯 문제 상황

### 문제 1: 시집이 학생 화면에 안 보여요!
관리자가 시집을 31권이나 등록했는데, 학생 대시보드에서 시집이 보이지 않았습니다.

**원인**: `StorybookLibrary` 컴포넌트가 `storybooks` 테이블만 불러오고, `poetry_collections` 테이블은 불러오지 않았기 때문입니다.

### 문제 2: 시집을 클릭하면 오류가 나요!
시집을 클릭했을 때 "동화책을 여는데 실패했습니다" 오류가 발생했습니다.

**원인**: 시집을 열 때 동화책용 함수(`student_get_storybook_pages`)를 사용했기 때문입니다. 시집은 `poems` 테이블에서 데이터를 가져와야 합니다.

---

## 🔧 해결 과정

### 1단계: 시집 데이터 불러오기

**파일**: `src/components/student/StorybookLibrary.tsx`

**수정 전** (동화책만 불러옴):
```typescript
const loadBooks = async () => {
  const { data, error } = await supabase.rpc('student_get_storybooks', {
    student_id_input: studentId
  });
  
  if (data) {
    setBooks(data);
  }
};
```

**수정 후** (동화책 + 시집 함께 불러옴):
```typescript
const loadBooks = async () => {
  // 1. 동화책 불러오기
  const { data: storybookData } = await supabase.rpc('student_get_storybooks', {
    student_id_input: studentId
  });

  // 2. 시집 불러오기
  const { data: poetryData } = await supabase.rpc('student_get_poetry_collections', {
    student_id_input: studentId
  });

  // 3. 시집 데이터를 동화책 형식으로 변환
  const poetryBooks = (poetryData || []).map((poetry: any, index: number) => ({
    id: poetry.id,
    title: poetry.title,
    subtitle: poetry.poet,           // 시인 이름을 부제목으로
    book_number: 100 + index,        // 시집 번호는 100번대부터
    category: 'poetry',              // 카테고리를 'poetry'로 설정
    cover_image_url: poetry.cover_image_url,
    page_count: poetry.poem_count,   // 시 개수를 페이지 수로
    is_completed: poetry.is_completed,
    last_page: poetry.last_poem_order
  }));

  // 4. 동화책과 시집 합치기
  const allBooks = [...(storybookData || []), ...poetryBooks];
  setBooks(allBooks);
};
```

#### 💡 핵심 개념: 스프레드 연산자 (`...`)
```typescript
const 과일 = ['사과', '바나나'];
const 채소 = ['당근', '양파'];
const 음식 = [...과일, ...채소];  // ['사과', '바나나', '당근', '양파']
```

---

### 2단계: 시집 열기 기능 수정

시집을 클릭했을 때 시(poems)를 불러오도록 수정했습니다.

**수정 전** (모든 책을 동화책 방식으로 열음):
```typescript
const openBook = async (book: Storybook) => {
  const { data } = await supabase.rpc('student_get_storybook_pages', {
    book_id_input: book.id,
    student_id_input: studentId
  });
  setPages(data || []);
};
```

**수정 후** (시집과 동화책을 다르게 처리):
```typescript
const openBook = async (book: Storybook) => {
  // 시집인 경우
  if (book.category === 'poetry') {
    const { data } = await supabase.rpc('student_get_poems', {
      collection_id_input: book.id,
      student_id_input: studentId
    });
    
    // 시 데이터를 페이지 형식으로 변환
    const poemPages = (data || []).map((poem: any) => ({
      id: poem.id,
      page_number: poem.poem_order,
      text_content: `# ${poem.title}\n\n${poem.content}`,
      image_url: null
    }));
    
    setPages(poemPages);
  } 
  // 동화책인 경우
  else {
    const { data } = await supabase.rpc('student_get_storybook_pages', {
      book_id_input: book.id,
      student_id_input: studentId
    });
    setPages(data || []);
  }
};
```

#### 💡 핵심 개념: 조건문 (if-else)
```typescript
if (조건) {
  // 조건이 참일 때 실행
} else {
  // 조건이 거짓일 때 실행
}
```

---

### 3단계: "시를 소리내어 낭독" 버튼 추가

시집 아코디언에 낭독 버튼을 추가했습니다.

**수정 전**:
```tsx
<Button onClick={() => setShowMyReviews(!showMyReviews)}>
  <PenLine className="w-4 h-4 mr-1" />
  시를 따라 적어보는 필사 ({seriesReviews.length})
</Button>
```

**수정 후**:
```tsx
<div className="flex gap-2">
  {/* 시집일 때만 낭독 버튼 표시 */}
  {series.id === 'poetry' && (
    <Button variant="outline" size="sm">
      <Volume2 className="w-4 h-4 mr-1" />
      시를 소리내어 낭독
    </Button>
  )}
  
  <Button onClick={() => setShowMyReviews(!showMyReviews)}>
    <PenLine className="w-4 h-4 mr-1" />
    {series.id === 'poetry' ? '시를 따라 적어보는 필사' : '내 독후감'} ({seriesReviews.length})
  </Button>
</div>
```

#### 💡 핵심 개념: 조건부 렌더링
```tsx
{조건 && <컴포넌트 />}  // 조건이 참일 때만 컴포넌트 표시
```

---

## 📊 데이터베이스 구조

### storybooks 테이블 (동화책)
| 컬럼명 | 설명 |
|--------|------|
| id | 고유 ID |
| title | 제목 |
| book_number | 책 번호 |
| category | 카테고리 |
| page_count | 페이지 수 |

### poetry_collections 테이블 (시집)
| 컬럼명 | 설명 |
|--------|------|
| id | 고유 ID |
| title | 제목 |
| poet | 시인 |
| poem_count | 시 개수 |

### poems 테이블 (개별 시)
| 컬럼명 | 설명 |
|--------|------|
| id | 고유 ID |
| collection_id | 시집 ID |
| title | 시 제목 |
| content | 시 내용 |
| poem_order | 순서 |

---

## 🎓 실습 과제

### 초급
1. `category === 'poetry'` 조건을 `category === 'novel'`로 바꾸면 어떻게 될까요?

### 중급
2. 시집 버튼에 시 개수를 표시해보세요. (힌트: `poem_count` 사용)

### 고급
3. "시를 소리내어 낭독" 버튼을 클릭하면 TTS(Text-to-Speech)로 시를 읽어주는 기능을 구현해보세요.

---

## 📝 오늘의 핵심 정리

| 개념 | 설명 | 예시 |
|------|------|------|
| 스프레드 연산자 | 배열을 펼쳐서 합치기 | `[...a, ...b]` |
| 조건문 | 상황에 따라 다른 코드 실행 | `if (조건) { } else { }` |
| 조건부 렌더링 | 조건에 따라 UI 표시/숨김 | `{조건 && <컴포넌트/>}` |
| 데이터 변환 | 한 형식을 다른 형식으로 바꾸기 | `data.map(item => ({...}))` |

---

## 🔗 관련 파일
- `src/components/student/StorybookLibrary.tsx` - 인문학 서점 메인 컴포넌트
- `src/config/bookSeriesConfig.ts` - 시리즈 설정 파일
